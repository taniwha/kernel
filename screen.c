#include "textfont.h"
#include "textmode.h"
#include "s386.h"
#include "serio.h"

static SioPort *port;

static int x=0,y=0;
static short *const screen=(short*)0xb8000;

static char fnt[]={
	0xff,0x81,0x81,0x81,0x81,0x81,0x81,0xff,
	0x7E,0x81,0xA5,0x81,0xBD,0x99,0x81,0x7E,
	0x7E,0xFF,0xDB,0xFF,0xC3,0xE7,0xFF,0x7E,
	0x6C,0xFE,0xFE,0xFE,0x7C,0x38,0x10,0x00,
	0x08,0x1C,0x3E,0x7F,0x3E,0x1C,0x08,0x00,
	0x1C,0x1C,0x1C,0x7F,0x7F,0x6B,0x08,0x1C,
	0x10,0x10,0x38,0x7C,0xFE,0x7C,0x10,0x38,
	0x00,0x00,0x18,0x3C,0x3C,0x18,0x00,0x00,
	0xFF,0xFF,0xE7,0xC3,0xC3,0xE7,0xFF,0xFF,
	0x00,0x3C,0x66,0x42,0x42,0x66,0x3C,0x00,
	0xFF,0xC3,0x99,0xBD,0xBD,0x99,0xC3,0xFF,
	0x0F,0x07,0x0F,0x7D,0xCC,0xCC,0xCC,0x78,
	0x3C,0x66,0x66,0x66,0x3C,0x18,0x7E,0x18,
	0x3F,0x33,0x3F,0x30,0x30,0x70,0xF0,0xE0,
	0x7F,0x63,0x7F,0x63,0x63,0x67,0xE6,0xC0,
	0x18,0xDB,0x3C,0xE7,0xE7,0x3C,0xDB,0x18,
	0x80,0xE0,0xF8,0xFE,0xF8,0xE0,0x80,0x00,
	0x02,0x0E,0x3E,0xFE,0x3E,0x0E,0x02,0x00,
	0x18,0x3C,0x7E,0x18,0x18,0x7E,0x3C,0x18,
	0x66,0x66,0x66,0x66,0x66,0x00,0x66,0x00,
	0x7F,0xDB,0xDB,0x7B,0x1B,0x1B,0x1B,0x00,
	0x3E,0x63,0x38,0x6C,0x6C,0x38,0xCC,0x78,
	0x00,0x00,0x00,0x00,0x7E,0x7E,0x7E,0x00,
	0x18,0x3C,0x7E,0x18,0x7E,0x3C,0x18,0xFF,
	0x18,0x3C,0x7E,0x18,0x18,0x18,0x18,0x00,
	0x18,0x18,0x18,0x18,0x7E,0x3C,0x18,0x00,
	0x00,0x18,0x0C,0xFE,0x0C,0x18,0x00,0x00,
	0x00,0x30,0x60,0xFE,0x60,0x30,0x00,0x00,
	0x00,0x00,0xC0,0xC0,0xC0,0xFE,0x00,0x00,
	0x00,0x24,0x66,0xFF,0x66,0x24,0x00,0x00,
	0x00,0x18,0x3C,0x7E,0xFF,0xFF,0x00,0x00,
	0x00,0xFF,0xFF,0x7E,0x3C,0x18,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x30,0x78,0x78,0x30,0x30,0x00,0x30,0x00,
	0x6C,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,
	0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00,
	0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x00,
	0x00,0x63,0x66,0x0C,0x18,0x33,0x63,0x00,
	0x1C,0x36,0x1C,0x3B,0x6E,0x66,0x3B,0x00,
	0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,
	0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00,
	0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00,
	0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,
	0x00,0x30,0x30,0xFC,0x30,0x30,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30,
	0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,
	0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00,
	0x3E,0x63,0x67,0x6F,0x7B,0x73,0x3E,0x00,
	0x18,0x38,0x58,0x18,0x18,0x18,0x7E,0x00,
	0x3C,0x66,0x06,0x1C,0x30,0x66,0x7E,0x00,
	0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00,
	0x0E,0x1E,0x36,0x66,0x7F,0x06,0x0F,0x00,
	0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00,
	0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00,
	0x7E,0x66,0x06,0x0C,0x18,0x18,0x18,0x00,
	0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00,
	0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00,
	0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00,
	0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30,
	0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x00,
	0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,
	0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x00,
	0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00,
	0x3E,0x63,0x6F,0x69,0x6F,0x60,0x3E,0x00,
	0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00,
	0x7E,0x33,0x33,0x3E,0x33,0x33,0x7E,0x00,
	0x1E,0x33,0x60,0x60,0x60,0x33,0x1E,0x00,
	0x7C,0x36,0x33,0x33,0x33,0x36,0x7C,0x00,
	0x7F,0x31,0x34,0x3C,0x34,0x31,0x7F,0x00,
	0x7F,0x31,0x34,0x3C,0x34,0x30,0x78,0x00,
	0x1E,0x33,0x60,0x60,0x67,0x33,0x1F,0x00,
	0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00,
	0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,
	0x0F,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,
	0x73,0x33,0x36,0x3C,0x36,0x33,0x73,0x00,
	0x78,0x30,0x30,0x30,0x31,0x33,0x7F,0x00,
	0x63,0x77,0x7F,0x7F,0x6B,0x63,0x63,0x00,
	0x63,0x73,0x7B,0x6F,0x67,0x63,0x63,0x00,
	0x3E,0x63,0x63,0x63,0x63,0x63,0x3E,0x00,
	0x7E,0x33,0x33,0x3E,0x30,0x30,0x78,0x00,
	0x3C,0x66,0x66,0x66,0x6E,0x3C,0x0E,0x00,
	0x7E,0x33,0x33,0x3E,0x36,0x33,0x73,0x00,
	0x3C,0x66,0x30,0x18,0x0C,0x66,0x3C,0x00,
	0x7E,0x5A,0x18,0x18,0x18,0x18,0x3C,0x00,
	0x66,0x66,0x66,0x66,0x66,0x66,0x7E,0x00,
	0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00,
	0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00,
	0x63,0x63,0x36,0x1C,0x1C,0x36,0x63,0x00,
	0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00,
	0x7F,0x63,0x46,0x0C,0x19,0x33,0x7F,0x00,
	0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,
	0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00,
	0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,
	0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
	0x18,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x3C,0x06,0x3E,0x66,0x3B,0x00,
	0x70,0x30,0x30,0x3E,0x33,0x33,0x6E,0x00,
	0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00,
	0x0E,0x06,0x06,0x3E,0x66,0x66,0x3B,0x00,
	0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00,
	0x1C,0x36,0x30,0x78,0x30,0x30,0x78,0x00,
	0x00,0x00,0x3B,0x66,0x66,0x3E,0x06,0x7C,
	0x70,0x30,0x36,0x3B,0x33,0x33,0x73,0x00,
	0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00,
	0x06,0x00,0x06,0x06,0x06,0x66,0x66,0x3C,
	0x70,0x30,0x33,0x36,0x3C,0x36,0x73,0x00,
	0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,
	0x00,0x00,0x66,0x7F,0x7F,0x6B,0x63,0x00,
	0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00,
	0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00,
	0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x78,
	0x00,0x00,0x3B,0x66,0x66,0x3E,0x06,0x0F,
	0x00,0x00,0x6E,0x3B,0x33,0x30,0x78,0x00,
	0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00,
	0x08,0x18,0x3E,0x18,0x18,0x1A,0x0C,0x00,
	0x00,0x00,0x66,0x66,0x66,0x66,0x3B,0x00,
	0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00,
	0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00,
	0x00,0x00,0x63,0x36,0x1C,0x36,0x63,0x00,
	0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x7C,
	0x00,0x00,0x7E,0x4C,0x18,0x32,0x7E,0x00,
	0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00,
	0x0C,0x0C,0x0C,0x00,0x0C,0x0C,0x0C,0x00,
	0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00,
	0x3B,0x6E,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x08,0x1C,0x36,0x63,0x63,0x7F,0x00,
	0x3C,0x66,0x60,0x66,0x3C,0x0C,0x06,0x3C,
	0x00,0x66,0x00,0x66,0x66,0x66,0x3F,0x00,
	0x1C,0x00,0x78,0xCC,0xFC,0xC0,0x78,0x00,
	0x7E,0xC3,0x3C,0x06,0x3E,0x66,0x3F,0x00,
	0x66,0x00,0x3C,0x06,0x3E,0x66,0x3F,0x00,
	0x70,0x00,0x3C,0x06,0x3E,0x66,0x3F,0x00,
	0x18,0x18,0x3C,0x06,0x3E,0x66,0x3F,0x00,
	0x00,0x00,0x3C,0x60,0x60,0x3C,0x06,0x1C,
	0x7E,0xC3,0x3C,0x66,0x7E,0x60,0x3C,0x00,
	0xCC,0x00,0x78,0xCC,0xFC,0xC0,0x78,0x00,
	0x70,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00,
	0x66,0x00,0x38,0x18,0x18,0x18,0x3C,0x00,
	0x3E,0x63,0x1C,0x0C,0x0C,0x0C,0x1E,0x00,
	0x70,0x00,0x38,0x18,0x18,0x18,0x3C,0x00,
	0x63,0x1C,0x36,0x63,0x7F,0x63,0x63,0x00,
	0x18,0x18,0x00,0x3C,0x66,0x7E,0x66,0x00,
	0x1C,0x00,0xFC,0x60,0x78,0x60,0xFC,0x00,
	0x00,0x00,0x7F,0x0C,0x7F,0xCC,0x7F,0x00,
	0x1F,0x36,0x66,0x7F,0x66,0x66,0x67,0x00,
	0x3C,0x66,0x00,0x3C,0x66,0x66,0x3C,0x00,
	0x00,0x66,0x00,0x3C,0x66,0x66,0x3C,0x00,
	0x00,0x70,0x00,0x3C,0x66,0x66,0x3C,0x00,
	0x3C,0x66,0x00,0x66,0x66,0x66,0x3F,0x00,
	0x00,0x70,0x00,0x66,0x66,0x66,0x3F,0x00,
	0x00,0xCC,0x00,0xCC,0xCC,0x7C,0x0C,0xF8,
	0xC3,0x18,0x3C,0x66,0x66,0x3C,0x18,0x00,
	0x66,0x00,0x66,0x66,0x66,0x66,0x3C,0x00,
	0x0C,0x0C,0x3F,0x60,0x60,0x3F,0x0C,0x0C,
	0x1C,0x36,0x32,0x78,0x30,0x73,0x7E,0x00,
	0x66,0x66,0x3C,0x7E,0x18,0x7E,0x18,0x18,
	0xF8,0xCC,0xCC,0xFA,0xC6,0xCF,0xC6,0xC7,
	0x0E,0x1B,0x18,0x3C,0x18,0x18,0xD8,0x70,
	0x0E,0x00,0x3C,0x06,0x3E,0x66,0x3F,0x00,
	0x1C,0x00,0x38,0x18,0x18,0x18,0x3C,0x00,
	0x00,0x0E,0x00,0x3C,0x66,0x66,0x3C,0x00,
	0x00,0x0E,0x00,0x66,0x66,0x66,0x3F,0x00,
	0x00,0x7C,0x00,0x7C,0x66,0x66,0x66,0x00,
	0x7E,0x00,0x66,0x76,0x7E,0x6E,0x66,0x00,
	0x1E,0x36,0x36,0x1F,0x00,0x3F,0x00,0x00,
	0x1C,0x36,0x36,0x1C,0x00,0x3E,0x00,0x00,
	0x18,0x00,0x18,0x30,0x60,0x66,0x3C,0x00,
	0x00,0x00,0x00,0x7E,0x60,0x60,0x00,0x00,
	0x00,0x00,0x00,0xFC,0x0C,0x0C,0x00,0x00,
	0xC3,0xC6,0xCC,0xDE,0x33,0x66,0xCC,0x0F,
	0xC3,0xC6,0xCC,0xDB,0x37,0x6F,0xCF,0x03,
	0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x00,
	0x00,0x33,0x66,0xCC,0x66,0x33,0x00,0x00,
	0x00,0xCC,0x66,0x33,0x66,0xCC,0x00,0x00,
	0x22,0x88,0x22,0x88,0x22,0x88,0x22,0x88,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,0xAA,
	0xDB,0x77,0xDB,0xEE,0xDB,0x77,0xDB,0xEE,
	0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
	0x18,0x18,0x18,0x18,0xF8,0x18,0x18,0x18,
	0x18,0x18,0xF8,0x18,0xF8,0x18,0x18,0x18,
	0x36,0x36,0x36,0x36,0xF6,0x36,0x36,0x36,
	0x00,0x00,0x00,0x00,0xFE,0x36,0x36,0x36,
	0x00,0x00,0xF8,0x18,0xF8,0x18,0x18,0x18,
	0x36,0x36,0xF6,0x06,0xF6,0x36,0x36,0x36,
	0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
	0x00,0x00,0xFE,0x06,0xF6,0x36,0x36,0x36,
	0x36,0x36,0xF6,0x06,0xFE,0x00,0x00,0x00,
	0x36,0x36,0x36,0x36,0xFE,0x00,0x00,0x00,
	0x18,0x18,0xF8,0x18,0xF8,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xF8,0x18,0x18,0x18,
	0x18,0x18,0x18,0x18,0x1F,0x00,0x00,0x00,
	0x18,0x18,0x18,0x18,0xFF,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xFF,0x18,0x18,0x18,
	0x18,0x18,0x18,0x18,0x1F,0x18,0x18,0x18,
	0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,
	0x18,0x18,0x18,0x18,0xFF,0x18,0x18,0x18,
	0x18,0x18,0x1F,0x18,0x1F,0x18,0x18,0x18,
	0x36,0x36,0x36,0x36,0x37,0x36,0x36,0x36,
	0x36,0x36,0x37,0x30,0x3F,0x00,0x00,0x00,
	0x00,0x00,0x3F,0x30,0x37,0x36,0x36,0x36,
	0x36,0x36,0xF7,0x00,0xFF,0x00,0x00,0x00,
	0x00,0x00,0xFF,0x00,0xF7,0x36,0x36,0x36,
	0x36,0x36,0x37,0x30,0x37,0x36,0x36,0x36,
	0x00,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,
	0x36,0x36,0xF7,0x00,0xF7,0x36,0x36,0x36,
	0x18,0x18,0xFF,0x00,0xFF,0x00,0x00,0x00,
	0x36,0x36,0x36,0x36,0xFF,0x00,0x00,0x00,
	0x00,0x00,0xFF,0x00,0xFF,0x18,0x18,0x18,
	0x00,0x00,0x00,0x00,0xFF,0x36,0x36,0x36,
	0x36,0x36,0x36,0x36,0x3F,0x00,0x00,0x00,
	0x18,0x18,0x1F,0x18,0x1F,0x00,0x00,0x00,
	0x00,0x00,0x1F,0x18,0x1F,0x18,0x18,0x18,
	0x00,0x00,0x00,0x00,0x3F,0x36,0x36,0x36,
	0x36,0x36,0x36,0x36,0xFF,0x36,0x36,0x36,
	0x18,0x18,0xFF,0x18,0xFF,0x18,0x18,0x18,
	0x18,0x18,0x18,0x18,0xF8,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x1F,0x18,0x18,0x18,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,
	0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
	0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,
	0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
	0x00,0x00,0x3B,0x6E,0x64,0x6E,0x3B,0x00,
	0x00,0x3C,0x66,0x7C,0x66,0x7C,0x60,0x60,
	0x00,0x7E,0x66,0x60,0x60,0x60,0x60,0x00,
	0x00,0x7F,0x36,0x36,0x36,0x36,0x36,0x00,
	0x7E,0x66,0x30,0x18,0x30,0x66,0x7E,0x00,
	0x00,0x00,0x3F,0x6C,0x6C,0x6C,0x38,0x00,
	0x00,0x33,0x33,0x33,0x33,0x3E,0x30,0x60,
	0x00,0x3B,0x6E,0x0C,0x0C,0x0C,0x0C,0x00,
	0x7E,0x18,0x3C,0x66,0x66,0x3C,0x18,0x7E,
	0x1C,0x36,0x63,0x7F,0x63,0x36,0x1C,0x00,
	0x1C,0x36,0x63,0x63,0x36,0x36,0x77,0x00,
	0x0E,0x18,0x0C,0x3E,0x66,0x66,0x3C,0x00,
	0x00,0x00,0x7E,0xDB,0xDB,0x7E,0x00,0x00,
	0x06,0x0C,0x7E,0xDB,0xDB,0x7E,0x60,0xC0,
	0x1C,0x30,0x60,0x7C,0x60,0x30,0x1C,0x00,
	0x3C,0x66,0x66,0x66,0x66,0x66,0x66,0x00,
	0x00,0x7E,0x00,0x7E,0x00,0x7E,0x00,0x00,
	0x18,0x18,0x7E,0x18,0x18,0x00,0x7E,0x00,
	0x30,0x18,0x0C,0x18,0x30,0x00,0x7E,0x00,
	0x0C,0x18,0x30,0x18,0x0C,0x00,0x7E,0x00,
	0x0E,0x1B,0x1B,0x18,0x18,0x18,0x18,0x18,
	0x18,0x18,0x18,0x18,0x18,0xD8,0xD8,0x70,
	0x18,0x18,0x00,0x7E,0x00,0x18,0x18,0x00,
	0x00,0x3B,0x6E,0x00,0x3B,0x6E,0x00,0x00,
	0x1C,0x36,0x36,0x1C,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x0C,0x0C,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x18,0x00,0x00,0x00,
	0x0F,0x0C,0x0C,0x0C,0xEC,0x6C,0x3C,0x1C,
	0x78,0x6C,0x6C,0x6C,0x6C,0x00,0x00,0x00,
	0x70,0x18,0x30,0x60,0x78,0x00,0x00,0x00,
	0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00,
	0xff,0x99,0x99,0xff,0xff,0x99,0x99,0xff,
};

void kinitscr(void)
{
	int c,l;

	set480lines();
	AccessFont();
	for (c=0; c<256; c++) {
		for (l=0; l<8; l++) {
			((char*)screen)[c*32+l]=fnt[c*8+l];
		}
	}
	AccessText();
	SetFontHeight(8);
}

void kcls(void)
{
	int i;
	short addr;
	for (i=0; i<4800; i++) screen[i]=0x0720;
	x=y=0;
	addr=x+y*80;
	outb(0x3d4,0xf);
	outb(0x3d5,addr);
	outb(0x3d4,0xe);
	outb(0x3d5,addr/256);
}

char kputc(char c)
{
	short *s,*d;
	int i;
	short addr;

	switch (c) {
	case '\t':
		do kputc(' '); while (x%8);
		break;
	case '\n':
		y++;
	case '\r':
		x=0;
		break;
	case '\b':
		if (x>0) x--;
		break;
	default:
		screen[y*80+x++]=(c&0xff)|0x0700;
	}
	if (x>=80) {
		x=0;
		y++;
	}
	if (y>=60) {
		y=59;
		d=screen;
		s=screen+80;
		for (i=0; i<4720; i++) *d++=*s++;
		for (i=0; i<80; i++) *d++=0x0720;
	}
	addr=x+y*80;
	outb(0x3d4,0xf);
	outb(0x3d5,addr);
	outb(0x3d4,0xe);
	outb(0x3d5,addr/256);
	if (port) while (sio_put(port,c));
	return c;
}

int kputs(char *s)
{
	int c=0;
	while (*s) {
		kputc(*s++);
		c++;
	}
	return c;
}

int kputd(int d)
{
	char s[33],*p;
	s[32]=0;
	s[31]='0';
	p=&s[31];
	if (d<0) {
		kputc('-');
		d=-d;
	}
	if (d) {
		while (d) {
			*p--=d%10+'0';
			d/=10;
		}
		p++;
	}
	kputs(p);
	return 0;
}

int kputh(unsigned int h)
{
	char s[33],*p,c;
	s[32]=0;
	s[31]='0';
	p=&s[31];
	if (h) {
		while (h) {
			c=h%16+'0';
			if (c>'9') c+='a'-'9'-1;
			*p--=c;
			h/=16;
		}
		p++;
	}
	kputs(p);
	return 0;
}

int kputx(unsigned int h)
{
	char s[33],*p,c;
	int i;

	s[32]=0;
	s[31]='0';
	p=&s[31];
	for (i=0; i<sizeof(int)*2; i++) {
		c=h%16+'0';
		if (c>'9') c+='a'-'9'-1;
		*p--=c;
		h/=16;
	}
	kputs(++p);
	return 0;
}

int kputsx(unsigned int h)
{
	char s[33],*p,c;
	int i;

	s[32]=0;
	s[31]='0';
	p=&s[31];
	for (i=0; i<sizeof(short)*2; i++) {
		c=h%16+'0';
		if (c>'9') c+='a'-'9'-1;
		*p--=c;
		h/=16;
	}
	kputs(++p);
	return 0;
}

int kputcx(unsigned int h)
{
	char s[33],*p,c;
	int i;

	s[32]=0;
	s[31]='0';
	p=&s[31];
	for (i=0; i<sizeof(char)*2; i++) {
		c=h%16+'0';
		if (c>'9') c+='a'-'9'-1;
		*p--=c;
		h/=16;
	}
	kputs(++p);
	return 0;
}

static void __attribute__((constructor)) screen_init(void)
{
	kcls();
/*	port=sio_openport(0x2f8,3);
	sio_setparms(port,sio8Bits,sioNoParity,sio1StopBit);
	sio_setspeed(port,6);	// 19200 baud*/
}
